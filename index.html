<style>
  * {
    box-sizing: border-box;
  }

  html, body {
    height: auto;
    min-height: 0;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    padding: 0;
    margin: 0;
    background: var(--figma-color-bg);
    color: var(--figma-color-text);
    font-size: 11px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-height: 0;
  }

  .header {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  h2 {
    font-size: 13px;
    font-weight: 600;
    margin: 0;
    color: var(--figma-color-text);
    letter-spacing: -0.01em;
  }

  .description {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    margin: 0;
    line-height: 1.4;
  }

  .button-group {
    display: flex;
    gap: 8px;
  }

  button {
    flex: 1;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 500;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    position: relative;
    overflow: hidden;
  }

  button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.4s, height 0.4s;
  }

  button:active::before {
    width: 300px;
    height: 300px;
  }

  button:active {
    transform: scale(0.97);
  }

  #delete {
    background: linear-gradient(135deg, #f24822 0%, #e03616 100%);
    color: white;
    box-shadow: 0 1px 2px rgba(242, 72, 34, 0.15);
  }

  #delete:hover {
    background: linear-gradient(135deg, #e03616 0%, #d02e10 100%);
    box-shadow: 0 2px 4px rgba(242, 72, 34, 0.2);
    transform: translateY(-1px);
  }

  #makeVisible {
    background: linear-gradient(135deg, #18a0fb 0%, #0d8ee0 100%);
    color: white;
    box-shadow: 0 1px 2px rgba(24, 160, 251, 0.15);
  }

  #makeVisible:hover {
    background: linear-gradient(135deg, #0d8ee0 0%, #0880d1 100%);
    box-shadow: 0 2px 4px rgba(24, 160, 251, 0.2);
    transform: translateY(-1px);
  }

  #result {
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 11px;
    line-height: 1.4;
    display: none;
    animation: slideIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 0;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #result.show {
    display: block;
    background: linear-gradient(135deg, #e8f5e9 0%, #d4edd6 100%);
    color: #2e7d32;
    border: 1px solid #a5d6a7;
  }

  #result.success {
    display: block;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    border: 1px solid #64b5f6;
    font-weight: 500;
  }

  #result.warning {
    display: block;
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    color: #f57c00;
    border: 1px solid #ffd54f;
  }

  #hiddenList {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--figma-color-border);
    border-radius: 8px;
    padding: 8px;
    display: none;
    background: var(--figma-color-bg-secondary);
    margin: 0;
  }

  #hiddenList.show {
    display: block;
    animation: fadeIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  #hiddenList::-webkit-scrollbar {
    width: 8px;
  }

  #hiddenList::-webkit-scrollbar-track {
    background: transparent;
  }

  #hiddenList::-webkit-scrollbar-thumb {
    background: var(--figma-color-border-strong);
    border-radius: 4px;
  }

  #hiddenList::-webkit-scrollbar-thumb:hover {
    background: var(--figma-color-text-tertiary);
  }

  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 0 4px;
    font-size: 11px;
    font-weight: 600;
    color: var(--figma-color-text);
  }

  .list-count {
    background: var(--figma-color-bg);
    color: var(--figma-color-text-secondary);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    min-width: 24px;
    text-align: center;
    border: 1px solid var(--figma-color-border);
  }

  .hidden-item {
    padding: 8px 10px;
    margin: 4px 0;
    background: var(--figma-color-bg);
    border: 1px solid var(--figma-color-border);
    border-radius: 6px;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
  }

  .hidden-item:hover {
    background: var(--figma-color-bg-hover);
    border-color: var(--figma-color-border-strong);
    transform: translateX(2px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .hidden-item:active {
    transform: scale(0.98);
  }

  .hidden-item.skipped {
    opacity: 0.5;
    background: var(--figma-color-bg-secondary);
    border-color: var(--figma-color-border);
    border-style: dashed;
  }

  .hidden-item.skipped:hover {
    opacity: 0.7;
    background: var(--figma-color-bg-hover);
  }

  .hidden-item-name {
    font-weight: 500;
    flex: 1;
    pointer-events: none;
    color: var(--figma-color-text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .hidden-item-icon {
    width: 16px;
    height: 16px;
    margin-left: 8px;
    flex-shrink: 0;
    pointer-events: none;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hidden-item:hover .hidden-item-icon {
    transform: scale(1.1);
  }

  .hidden-item-icon svg {
    pointer-events: none;
    fill: var(--figma-color-text-secondary);
    transition: fill 0.15s ease;
  }

  .hidden-item.skipped .hidden-item-icon svg {
    fill: var(--figma-color-text-tertiary);
  }

  .footer {
    margin-top: 8px;
    padding-top: 12px;
    border-top: 1px solid var(--figma-color-border);
    text-align: center;
    font-size: 10px;
    color: var(--figma-color-text-tertiary);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .footer a {
    color: #18a0fb;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .footer a:hover {
    color: #0d8ee0;
    text-decoration: underline;
  }

  .support-button {
    position: absolute;
    right: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--figma-color-bg-secondary);
    border: 1px solid var(--figma-color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
  }

  .support-button:hover {
    background: #18a0fb;
    border-color: #18a0fb;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(24, 160, 251, 0.3);
  }

  .support-button:active {
    transform: scale(0.95);
  }

  .support-icon {
    width: 16px;
    height: 16px;
    transition: opacity 0.2s ease;
  }

  .support-icon svg {
    width: 100%;
    height: 100%;
    fill: var(--figma-color-text-secondary);
    transition: fill 0.2s ease;
  }

  .support-button:hover .support-icon svg {
    fill: #ffffff;
  }

  .support-icon-default {
    position: absolute;
    opacity: 1;
  }

  .support-icon-hover {
    position: absolute;
    opacity: 0;
  }

  .support-button:hover .support-icon-default {
    opacity: 0;
  }

  .support-button:hover .support-icon-hover {
    opacity: 1;
  }

  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--figma-color-text-tertiary);
  }

  .empty-state-icon {
    font-size: 32px;
    margin-bottom: 8px;
    opacity: 0.5;
  }
</style>

<div class="container">
  <div class="header">
    <h2>Manage Hidden Layers</h2>
    <p class="description">Choose an action for all hidden items within your current selection.</p>
  </div>

  <div id="hiddenList" class="show">
    <div class="list-header"><strong>Hidden items found:</strong><span class="list-count">7</span></div>
    <div class="hidden-item" data-id="item1" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 1</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
    <div class="hidden-item" data-id="item2" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 2</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
    <div class="hidden-item" data-id="item3" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 3</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
    <div class="hidden-item" data-id="item4" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 4</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
    <div class="hidden-item" data-id="item5" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 5</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
    <div class="hidden-item" data-id="item6" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 6</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
    <div class="hidden-item" data-id="item7" data-skipped="false">
      <span class="hidden-item-name">Hidden Layer 7</span>
      <span class="hidden-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg></span>
    </div>
  </div>
  <div id="result"></div>

  <div class="button-group">
    <button id="delete">Delete Hidden Layers</button>
    <button id="makeVisible">Make Visible</button>
  </div>

  <div class="footer">
    <span title="Discover more design tools">© 2025 <a href="https://samolevsky.com/" target="_blank">Samolevsky.com</a></span>
    <button class="support-button" id="supportButton" title="Support plugin development">
      <span class="support-icon support-icon-default">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M16,2A14,14,0,1,0,30,16,14,14,0,0,0,16,2Zm0,26A12,12,0,1,1,28,16,12,12,0,0,1,16,28Z"/><path d="M11.5,11A2.5,2.5,0,1,0,14,13.5,2.48,2.48,0,0,0,11.5,11Z"/><path d="M20.5,11A2.5,2.5,0,1,0,23,13.5,2.48,2.48,0,0,0,20.5,11Z"/><path d="M16,24a8,8,0,0,0,6.85-3.89l-1.71-1a6,6,0,0,1-10.28,0l-1.71,1A8,8,0,0,0,16,24Z"/></svg>
      </span>
      <span class="support-icon support-icon-hover">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M16,2A14,14,0,1,0,30,16,14,14,0,0,0,16,2Zm0,26A12,12,0,1,1,28,16,12,12,0,0,1,16,28Z"/><path d="M20.5,11A2.5,2.5,0,1,0,23,13.5,2.5,2.5,0,0,0,20.5,11Z"/><rect x="8" y="13" width="6" height="2"/><path d="M16,24a8,8,0,0,0,6.85-3.89l-1.71-1a6,6,0,0,1-10.28,0l-1.71,1A8,8,0,0,0,16,24Z"/></svg>
      </span>
    </button>
  </div>
</div>

<script>
  const visibleIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/></svg>';
  const hiddenIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M5.24,22.51l1.43-1.42A14.06,14.06,0,0,1,3.07,16C5.1,10.93,10.7,7,16,7a12.38,12.38,0,0,1,4,.72l1.55-1.56A14.72,14.72,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16,16,0,0,0,5.24,22.51Z"/><path d="M12,15.73a4,4,0,0,1,3.7-3.7l1.81-1.82a6,6,0,0,0-7.33,7.33Z"/><path d="M30.94,15.66A16.4,16.4,0,0,0,25.2,8.22L30,3.41,28.59,2,2,28.59,3.41,30l5.1-5.1A15.29,15.29,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM20,16a4,4,0,0,1-6,3.44L19.44,14A4,4,0,0,1,20,16Zm-4,9a13.05,13.05,0,0,1-6-1.58l2.54-2.54a6,6,0,0,0,8.35-8.35l2.87-2.87A14.54,14.54,0,0,1,28.93,16C26.9,21.07,21.3,25,16,25Z"/></svg>';
  const skippedItems = new Set();

  document.getElementById('delete').onclick = () => {
    parent.postMessage({
      pluginMessage: {
        type: 'delete-hidden',
        skippedIds: Array.from(skippedItems)
      }
    }, '*')
  }

  document.getElementById('makeVisible').onclick = () => {
    parent.postMessage({
      pluginMessage: {
        type: 'make-visible',
        skippedIds: Array.from(skippedItems)
      }
    }, '*')
  }

  document.getElementById('supportButton').onclick = () => {
    parent.postMessage({
      pluginMessage: {
        type: 'open-url',
        url: 'https://www.patreon.com/c/samolevsky'
      }
    }, '*')
  }

  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;

    if (msg.type === 'hidden-list') {
      const listDiv = document.getElementById('hiddenList');
      const resultDiv = document.getElementById('result');
      skippedItems.clear();

      if (msg.items.length === 0) {
        resultDiv.textContent = 'No hidden items found in the selection.';
        resultDiv.className = 'warning';
        listDiv.classList.remove('show');
        listDiv.style.maxHeight = '';
        resizeWindow();
      } else {
        listDiv.innerHTML = '<div class="list-header"><strong>Hidden items found:</strong><span class="list-count">' + msg.items.length + '</span></div>';
        msg.items.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'hidden-item';
          itemDiv.dataset.id = item.id;
          itemDiv.dataset.skipped = 'false';

          const nameSpan = document.createElement('span');
          nameSpan.className = 'hidden-item-name';
          nameSpan.textContent = item.name;

          const iconContainer = document.createElement('span');
          iconContainer.className = 'hidden-item-icon';
          iconContainer.innerHTML = visibleIconSvg;

          itemDiv.appendChild(nameSpan);
          itemDiv.appendChild(iconContainer);

          itemDiv.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const isSkipped = this.dataset.skipped === 'true';

            if (isSkipped) {
              skippedItems.delete(item.id);
              this.dataset.skipped = 'false';
              iconContainer.innerHTML = visibleIconSvg;
              this.classList.remove('skipped');
            } else {
              skippedItems.add(item.id);
              this.dataset.skipped = 'true';
              iconContainer.innerHTML = hiddenIconSvg;
              this.classList.add('skipped');
            }
          });

          listDiv.appendChild(itemDiv);
        });
        
        // Adjust listbox height based on available space to keep footer visible
        updateListMaxHeight();
        
        listDiv.classList.add('show');
        resultDiv.classList.remove('show', 'warning');
        
        // Resize plugin window to fit content
        resizeWindow();
      }
    }

    if (msg.type === 'result') {
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = msg.message;
      resultDiv.className = msg.success ? 'success' : 'show';
      resizeWindow();
    }
  }

  function calculateHeight() {
    // Get all the elements
    const container = document.querySelector('.container');
    const hiddenList = document.getElementById('hiddenList');
    
    // Check if the list is scrollable (has items that overflow)
    const isListScrollable = hiddenList && 
                            hiddenList.classList.contains('show') && 
                            hiddenList.scrollHeight > hiddenList.clientHeight;
    
    if (isListScrollable) {
      // When list is scrollable, use container's offsetHeight (actual rendered height)
      // This respects the max-height constraint on the list
      return container.offsetHeight;
    } else {
      // When list is not scrollable, use scrollHeight to get natural content height
      return container.scrollHeight;
    }
  }

  function updateListMaxHeight() {
    const container = document.querySelector('.container');
    const listDiv = document.getElementById('hiddenList');
    if (!container || !listDiv || !listDiv.classList.contains('show')) return;

    const header = document.querySelector('.header');
    const resultDiv = document.getElementById('result');
    const buttonGroup = document.querySelector('.button-group');
    const footer = document.querySelector('.footer');

    const cs = getComputedStyle(container);
    const rowGap = parseFloat(cs.rowGap || cs.gap || '0');
    const paddingTop = parseFloat(cs.paddingTop || '0');
    const paddingBottom = parseFloat(cs.paddingBottom || '0');

    const children = [header, listDiv, resultDiv, buttonGroup, footer].filter(Boolean);
    const visibleCount = children.filter(el => el && el.offsetHeight > 0).length;

    const nonListHeight =
      (header ? header.offsetHeight : 0) +
      (resultDiv ? resultDiv.offsetHeight : 0) +
      (buttonGroup ? buttonGroup.offsetHeight : 0) +
      (footer ? footer.offsetHeight : 0) +
      paddingTop + paddingBottom +
      rowGap * Math.max(0, visibleCount - 1);

    const maxWindowHeight = 600; // keep in sync with resizeWindow clamp
    const available = Math.max(120, maxWindowHeight - nonListHeight - 2); // buffer
    listDiv.style.maxHeight = available + 'px';
  }

  function resizeWindow() {
    // Use setTimeout to ensure layout is complete
    setTimeout(() => {
      updateListMaxHeight();
      const height = calculateHeight();
      
      // Add buffer for safety
      const bufferedHeight = height + 2;
      
      // Set reasonable bounds
      const minHeight = 250;
      const maxHeight = 600;
      const newHeight = Math.max(minHeight, Math.min(bufferedHeight, maxHeight));
      
      parent.postMessage({
        pluginMessage: {
          type: 'resize',
          height: newHeight
        }
      }, '*');
    }, 100);
  }

  // Initial resize
  window.addEventListener('load', resizeWindow);
</script>